<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katelyn's Reading Log</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ckevac/katelynreads/main/KatelynReading.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/ckevac/katelynreads/main/KatelynReading.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        body { 
            font-family: 'Quicksand', sans-serif; 
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 50%, #fefce8 100%);
        }
        .card { border-radius: 24px; box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.05); }
        .btn-animate:active { transform: scale(0.95); }
        .pink-gradient { background: linear-gradient(to right, #ec4899, #d946ef); }
        .logo-container {
            position: relative; width: 110px; height: 110px; margin: 0 auto;
            overflow: hidden; border-radius: 9999px; border: 4px solid white;
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.2);
        }
        .profile-img { width: 100%; height: 100%; object-fit: cover; }
        .tab-active { border-bottom: 4px solid #ec4899; color: #ec4899; }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-red 2s infinite; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ec4899;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 card w-full max-w-md border-t-8 border-pink-400">
        <!-- Header -->
        <div class="text-center mb-4">
            <div class="logo-container mb-2">
                <img id="logoImg" src="https://raw.githubusercontent.com/ckevac/katelynreads/main/KatelynReading.png" 
                     onerror="this.src='https://api.dicebear.com/7.x/fun-emoji/svg?seed=reading&backgroundColor=fdf2f8'"
                     alt="Katelyn Reading" class="profile-img">
            </div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text pink-gradient">Katelyn's Reading Log</h1>
        </div>

        <!-- Navigation -->
        <div class="flex border-b border-gray-100 mb-6">
            <button id="tabLog" class="flex-1 py-2 font-bold text-gray-400 tab-active" onclick="switchTab('log')">‚úçÔ∏è Log</button>
            <button id="tabReport" class="flex-1 py-2 font-bold text-gray-400" onclick="switchTab('report')">üìä Reports</button>
        </div>

        <!-- LOG VIEW -->
        <div id="viewLog">
            <div class="mb-6 p-4 bg-purple-50 rounded-2xl border-2 border-purple-100">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-purple-400 uppercase">Reading Timer</span>
                    <button onclick="playAlarm()" class="text-[10px] bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full hover:bg-purple-300">üîî Test Sound</button>
                </div>
                
                <div id="timerDisplay" class="text-4xl font-bold text-center text-purple-600 mb-2">20:00</div>
                
                <div id="ipadReminder" class="hidden text-center mb-4">
                    <p class="text-[10px] font-bold text-red-500 uppercase animate-pulse-slow">
                        ‚ö†Ô∏è iPad Tip: Check "Silent Mode" in Control Center!
                    </p>
                </div>

                <div class="flex gap-2">
                    <input type="number" id="timerInput" placeholder="Min" min="1" value="20"
                        class="w-16 p-2 text-center border-2 border-purple-200 rounded-lg focus:outline-none font-bold">
                    <button id="setTimerBtn" class="flex-1 bg-purple-500 text-white font-bold py-2 rounded-lg btn-animate">Set</button>
                    <button id="startTimerBtn" class="flex-1 bg-green-500 text-white font-bold py-2 rounded-lg btn-animate">Start</button>
                    <button id="stopTimerBtn" class="flex-1 bg-red-400 text-white font-bold py-2 rounded-lg btn-animate hidden">Stop</button>
                </div>
            </div>

            <form id="readingForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase ml-1">Date</label>
                    <input type="date" id="date" required class="w-full p-3 border-2 border-pink-100 rounded-xl focus:border-pink-400 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase ml-1">Book Title</label>
                    <input type="text" id="title" placeholder="What are you reading?" required class="w-full p-3 border-2 border-purple-100 rounded-xl focus:border-purple-400 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase ml-1">Minutes Read</label>
                    <input type="number" id="duration" placeholder="0" required min="1" class="w-full p-3 border-2 border-yellow-200 rounded-xl focus:border-yellow-400 focus:outline-none font-bold">
                </div>
                <div class="flex gap-3">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="language" value="English" checked class="hidden peer">
                        <div class="text-sm text-center p-3 border-2 border-pink-100 rounded-xl peer-checked:bg-pink-500 peer-checked:text-white font-bold transition-all">English üá¨üáß</div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="language" value="French" class="hidden peer">
                        <div class="text-sm text-center p-3 border-2 border-purple-100 rounded-xl peer-checked:bg-purple-500 peer-checked:text-white font-bold transition-all">French üá´üá∑</div>
                    </label>
                </div>
                <button type="submit" id="submitBtn" class="w-full pink-gradient text-white font-bold py-4 rounded-xl shadow-lg btn-animate text-lg mt-2">Log Reading! ‚ú®</button>
            </form>
        </div>

        <!-- REPORT VIEW -->
        <div id="viewReport" class="hidden">
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <input type="month" id="reportMonth" class="p-2 bg-gray-50 rounded-xl border-none font-bold text-purple-600 focus:outline-none">
                    <div id="refreshIndicator" class="hidden"><div class="loader"></div></div>
                </div>

                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="updateChartFilter('All')" class="filter-btn flex-1 py-1 text-xs font-bold rounded-lg bg-white shadow-sm text-pink-600" data-filter="All">Both</button>
                    <button onclick="updateChartFilter('English')" class="filter-btn flex-1 py-1 text-xs font-bold rounded-lg text-gray-500" data-filter="English">EN</button>
                    <button onclick="updateChartFilter('French')" class="filter-btn flex-1 py-1 text-xs font-bold rounded-lg text-gray-500" data-filter="French">FR</button>
                </div>

                <div class="bg-white rounded-2xl border border-gray-100 p-2" style="height: 200px; position: relative;">
                    <canvas id="readingChart"></canvas>
                </div>

                <div id="statsSummary" class="grid grid-cols-2 gap-3 text-center">
                    <div class="bg-pink-50 p-3 rounded-xl border border-pink-100">
                        <div class="text-xs text-pink-400 font-bold uppercase">Total Time</div>
                        <div id="statTotal" class="text-xl font-bold text-pink-600">0 min</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-xl border border-purple-100">
                        <div class="text-xs text-purple-400 font-bold uppercase">Books</div>
                        <div id="statBooks" class="text-xl font-bold text-purple-600">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="status" class="mt-4 text-center hidden"></div>
    </div>

    <script>
        // --- CONFIG ---
        const scriptURL = 'https://script.google.com/macros/s/AKfycbz-QZeVDHM14hUZfzDlVovm-HeyAv6YQ0hi2k4QPEeRnvGP29lscStUjRSxPkg6hPEp/exec';
        let localData = []; 
        let currentFilter = 'All';
        let chartInstance;

        // --- AUDIO ENGINE ---
        let audioCtx;
        let audioBuffer;

        async function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            try {
                const response = await fetch('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            } catch (e) { console.error("Audio init error", e); }
        }

        function playAlarm() {
            if (!audioCtx || !audioBuffer) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }

        // --- FETCH DATA FROM SHEET ---
        async function fetchHistory() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.remove('hidden');
            try {
                const response = await fetch(scriptURL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                if (Array.isArray(data)) {
                    localData = data;
                    localStorage.setItem('katelyn_logs_backup', JSON.stringify(data));
                    renderChart();
                }
            } catch (e) {
                console.warn("Fetch failed, using local backup.", e);
                localData = JSON.parse(localStorage.getItem('katelyn_logs_backup') || '[]');
                renderChart();
            } finally {
                indicator.classList.add('hidden');
            }
        }

        // --- TABS ---
        function switchTab(t) {
            document.getElementById('viewLog').classList.toggle('hidden', t !== 'log');
            document.getElementById('viewReport').classList.toggle('hidden', t !== 'report');
            document.getElementById('tabLog').classList.toggle('tab-active', t === 'log');
            document.getElementById('tabReport').classList.toggle('tab-active', t === 'report');
            if (t === 'report') fetchHistory();
        }

        // --- TIMER ---
        let timerInterval, timeLeft = 1200;
        const display = document.getElementById('timerDisplay');
        
        function updateDisplay() {
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            display.innerText = `${m}:${s.toString().padStart(2, '0')}`;
        }

        document.getElementById('setTimerBtn').onclick = () => {
            timeLeft = parseInt(document.getElementById('timerInput').value || 20) * 60;
            updateDisplay();
        };

        document.getElementById('startTimerBtn').onclick = async () => {
            await initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            document.getElementById('startTimerBtn').classList.add('hidden');
            document.getElementById('stopTimerBtn').classList.remove('hidden');
            document.getElementById('ipadReminder').classList.remove('hidden');

            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    playAlarm();
                    document.getElementById('duration').value = document.getElementById('timerInput').value;
                    showMessage("‚è∞ Time's up! Great reading!", "bg-purple-600 text-white shadow-xl");
                    document.getElementById('stopTimerBtn').click();
                }
            }, 1000);
        };

        document.getElementById('stopTimerBtn').onclick = () => {
            clearInterval(timerInterval);
            document.getElementById('stopTimerBtn').classList.add('hidden');
            document.getElementById('startTimerBtn').classList.remove('hidden');
            document.getElementById('ipadReminder').classList.add('hidden');
        };

        // --- SUBMIT LOG ---
        document.getElementById('readingForm').onsubmit = async (e) => {
            e.preventDefault();
            const log = {
                date: document.getElementById('date').value,
                title: document.getElementById('title').value,
                duration: parseInt(document.getElementById('duration').value),
                language: document.querySelector('input[name="language"]:checked').value
            };

            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Saving... üåü";

            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(log) 
                });
                
                showMessage("Great job! Saved to your sheet. üìñ", "bg-green-100 text-green-700");
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
                
                localData.push(log);
                localStorage.setItem('katelyn_logs_backup', JSON.stringify(localData));
            } catch (e) {
                showMessage("Check internet connection.", "bg-red-100 text-red-700");
            } finally {
                btn.disabled = false; btn.innerText = "Log Reading! ‚ú®";
            }
        };

        // --- CHART & FILTERS ---
        function updateChartFilter(lang) {
            currentFilter = lang;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.filter === lang;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-pink-600', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
            });
            renderChart();
        }

        document.getElementById('reportMonth').onchange = renderChart;

        function renderChart() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;

            const filtered = localData.filter(d => {
                const dDate = d.date.substring(0, 7);
                const matchMonth = dDate === month;
                const matchLang = currentFilter === 'All' || d.language === currentFilter;
                return matchMonth && matchLang;
            });

            const books = new Set(filtered.map(d => d.title.toLowerCase().trim()));
            const total = filtered.reduce((acc, d) => acc + Number(d.duration), 0);

            document.getElementById('statTotal').innerText = `${total} min`;
            document.getElementById('statBooks').innerText = books.size;

            const ctx = document.getElementById('readingChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const daysInMonth = 31;
            const daysLabels = Array.from({length: daysInMonth}, (_, i) => i + 1);

            // Datasets configuration
            let datasets = [];

            if (currentFilter === 'All') {
                // Stacked View: Separate English and French
                const englishData = daysLabels.map(day => {
                    const dayStr = `${month}-${day.toString().padStart(2, '0')}`;
                    return filtered
                        .filter(d => d.date === dayStr && d.language === 'English')
                        .reduce((a, b) => a + Number(b.duration), 0);
                });

                const frenchData = daysLabels.map(day => {
                    const dayStr = `${month}-${day.toString().padStart(2, '0')}`;
                    return filtered
                        .filter(d => d.date === dayStr && d.language === 'French')
                        .reduce((a, b) => a + Number(b.duration), 0);
                });

                datasets = [
                    {
                        label: 'English',
                        data: englishData,
                        backgroundColor: '#ec4899', // Pink
                        borderRadius: 4
                    },
                    {
                        label: 'French',
                        data: frenchData,
                        backgroundColor: '#a855f7', // Purple
                        borderRadius: 4
                    }
                ];
            } else {
                // Single Filter View
                const singleData = daysLabels.map(day => {
                    const dayStr = `${month}-${day.toString().padStart(2, '0')}`;
                    return filtered
                        .filter(d => d.date === dayStr)
                        .reduce((a, b) => a + Number(b.duration), 0);
                });

                datasets = [{
                    data: singleData,
                    backgroundColor: currentFilter === 'French' ? '#a855f7' : '#ec4899',
                    borderRadius: 4
                }];
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: daysLabels,
                    datasets: datasets
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label ? context.dataset.label + ': ' : ''}${context.parsed.y} min`;
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            stacked: true,
                            beginAtZero: true, 
                            grid: { color: '#f3f4f6' }, 
                            ticks: { stepSize: 10 } 
                        }, 
                        x: { 
                            stacked: true,
                            grid: { display: false } 
                        } 
                    }
                }
            });
        }

        function showMessage(msg, cls) {
            const s = document.getElementById('status');
            s.className = `mt-4 p-4 rounded-xl text-center font-bold transition-all ${cls}`;
            s.innerText = msg;
            s.classList.remove('hidden');
            setTimeout(() => s.classList.add('hidden'), 5000);
        }

        window.onload = () => {
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
            fetchHistory();
        };
    </script>
</body>
</html>
